name: Create Project Management README PR

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to link/close (e.g., 2)'
        required: true
        default: '2'
      branch_name:
        description: 'Branch name to create'
        required: true
        default: 'docs/add-readme-project-management'
      pr_title:
        description: 'Pull request title'
        required: true
        default: 'docs: Add Project Management README — overview & links'
      pr_body:
        description: 'Pull request body (will append "Closes #<issue_number>")'
        required: false
        default: 'Add a top-level README in docs/ that summarizes OctoAcme'\''s project management processes (initiation, planning, execution, release, retrospective), defines roles and QA expectations, and provides direct links to all process documents in docs/.'
      reviewer:
        description: 'Reviewer to request'
        required: true
        default: 'Pramit356'

permissions:
  contents: write
  pull-requests: write

jobs:
  create-readme-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch
        run: |
          git switch -c ${{ inputs.branch_name }}

      - name: Add docs/README.md
        run: |
          mkdir -p docs
          cat > docs/README.md <<'EOF'
# OctoAcme Project Management Docs — README

Welcome — this folder collects OctoAcme's project management process documents and provides a concise introduction to how we run projects. Use this README as the single entry point to find the one-pager, planning, execution, release, risk, retrospective, and roles documentation.

OctoAcme runs projects through a lightweight, iterative lifecycle that begins with a focused initiation step and moves through planning, execution, release, and retrospective phases. Initiation centers on a Project One-pager that defines the problem, SMART objectives, stakeholders, and success metrics. Planning translates that authorization into a prioritized, estimated backlog, an agreed Definition of Done, and a release/milestone plan. Risks and dependencies are tracked early in a Risk Register so mitigations can be assigned and monitored.

Day-to-day delivery follows visible workflows and a consistent team rhythm. Teams use a project board with columns (Backlog → Ready → In Progress → In Review → QA → Done), keep pull requests small and linked to issues and acceptance criteria, and require CI and at least one review before merging. Regular rituals include daily standups for blockers, weekly delivery syncs and PM + PdM alignment, demo/reviews at the end of sprints or milestones, and monthly stakeholder updates. Blocker escalation follows a clear path (team → PM → Product Lead → Sponsor) to resolve issues quickly.

Roles and quality practices are explicit to ensure accountability and maintain standards. PMs coordinate schedules, risks, and stakeholder communications; Product Managers define outcomes and prioritize work; Developers build and test; QA validates acceptance criteria and coordinates manual or exploratory verification as needed. Quality assurance is embedded in the pipeline with unit and integration tests, CI-based security scanning, end-to-end smoke tests for critical flows, and a pre-release checklist (CI green, release notes, rollback plan, and smoke verification). Retrospectives capture 2–3 action items with owners and timelines to drive continuous improvement.

## Process documentation links
- [Project Management Overview](docs/octoacme-project-management-overview.md)
- [Project Initiation Guide](docs/octoacme-project-initiation.md)
- [Project Planning](docs/octoacme-project-planning.md)
- [Execution & Tracking](docs/octoacme-execution-and-tracking.md)
- [Risk Management & Communication](docs/octoacme-risks-and-communication.md)
- [Release & Deployment Guide](docs/octoacme-release-and-deployment.md)
- [Retrospective & Continuous Improvement](docs/octoacme-retrospective-and-continuous-improvement.md)
- [Roles & Personas](docs/octoacme-roles-and-personas.md)
EOF

      - name: Commit changes
        run: |
          git add docs/README.md
          git commit -m "docs: add Project Management README with overview & links" || echo "No changes to commit"

      - name: Push branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push --set-upstream "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}" ${{ inputs.branch_name }}

      - name: Create PR and request reviewer
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt(core.getInput('issue_number', { required: true }), 10);
            const prTitle = core.getInput('pr_title') || `docs: Add Project Management README — overview & links`;
            const prBodyInput = core.getInput('pr_body') || '';
            const reviewer = core.getInput('reviewer') || '';
            const branch = core.getInput('branch_name');
            const base = process.env.GITHUB_BASE_REF || process.env.GITHUB_REF_NAME || 'main';

            const repo = context.repo;
            const { data: pr } = await github.rest.pulls.create({
              owner: repo.owner,
              repo: repo.repo,
              title: prTitle,
              head: branch,
              base: base,
              body: `${prBodyInput}\n\nCloses #${issueNumber}`
            });

            core.info(`Created PR #${pr.number}: ${pr.html_url}`);

            if (reviewer) {
              try {
                await github.rest.pulls.requestReviewers({
                  owner: repo.owner,
                  repo: repo.repo,
                  pull_number: pr.number,
                  reviewers: [reviewer]
                });
                core.info(`Requested review from ${reviewer}`);
              } catch (err) {
                core.warning(`Failed to request reviewer ${reviewer}: ${err.message}`);
              }
            }

            try {
              await github.rest.issues.addLabels({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: pr.number,
                labels: ['documentation','process improvement']
              });
            } catch (err) {
              core.warning(`Could not add labels: ${err.message}`);
            }

            try {
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: issueNumber,
                body: `A pull request has been opened to add the README: ${pr.html_url}`
              });
            } catch (err) {
              core.warning(`Could not comment on issue #${issueNumber}: ${err.message}`);
            }

            return pr.html_url

      - name: Output PR URL
        if: always()
        run: echo "PR creation step completed."
